import * as alt from 'alt-client';
import * as native from 'natives';
import { clientColshape } from '../Utils/methods';
import { browser } from '../Browser/app';
import { addNotify } from '../Events/hud';

let player = alt.Player.local;
let busWayType = 0; // 0 - first way, 1 - second way
let buswork = false;

let salary = 100;
let earnedMoney = 0;

let blip = new alt.PointBlip(-2033.3143310546875, -462.3428649902344, 11.4190673828125);
blip.sprite = 513;
blip.color = 84;
blip.shortRange = true;

alt.on('Bus_showBusWindow::CLIENT', () => {
    browser.emit('Bus_show::CEF', true);
    browser.focus();
    alt.toggleGameControls(false);
    alt.emit('Chat_hide', true);
    alt.showCursor(true);
    alt.emit('HUD_show::CLIENT', false);
    native.displayHud(false);
    native.displayRadar(false);
});

alt.on('Bus_hideBusWindow::CLIENT', () => {
    browser.emit('Bus_show::CEF', false);
    browser.unfocus();
    alt.toggleGameControls(true);
    alt.emit('Chat_hide', false);
    alt.showCursor(false);
    alt.emit('HUD_show::CLIENT', true);
    native.displayHud(true);
    native.displayRadar(true);
});

alt.onServer('TaskLeaveVehicle::NATIVE', (vehicle) => {
    native.taskLeaveVehicle(player, vehicle, 0);
});

let opened = false;
alt.on('keydown', (key) => {
    if (key == 0x45) {
        if (!opened) {
            if (player.getSyncedMeta('IN_BUS_COLSHAPE') == true) {
                alt.emit('Bus_showBusWindow::CLIENT');
                opened = true;
            }
        }
    } else if (key == 0x1b) {
        if (opened) {
            alt.emit('Bus_hideBusWindow::CLIENT');
            opened = false;
        }
    }
});

const BusWork = {
    busColshape: null,
    busCheckpoint: null,
    busBlip: null,
    blipType: null,
    colshapeType: null,
    earn: null,
    idx: 0,
    isStop: false,
    rgba: null,

    ways: [
        [
            { x: -1946.228515625, y: -495.3758239746094, z: 11.3685302734375 },
            { x: -1892.1494140625, y: -540.6593627929688, z: 11.2843017578125 },
            { x: -1901.5252685546875, y: -512.8746948242188, z: 11.3348388671875 },
            { x: -2072.16259765625, y: -382.5362548828125, z: 11.4359130859375 },
            { x: -2314.760498046875, y: -308.5186767578125, z: 13.3568115234375 },
            { x: -2570.24169921875, y: -158.95384216308594, z: 20.3157958984375 },
            { x: -2798.980224609375, y: 45.42857360839844, z: 14.4520263671875 },
            { x: -3025.384521484375, y: 216.75164794921875, z: 15.6651611328125 },
            { x: -2982.527587890625, y: 491.037353515625, z: 14.7890625 },
            { x: -3081.560546875, y: 778.2725219726562, z: 19.4058837890625 },
            { x: -3108.38232421875, y: 1068.5538330078125, z: 19.978759765625 },
            { x: -3056.505615234375, y: 1382.874755859375, z: 20.2821044921875 },
            { x: -2984.716552734375, y: 1588.747314453125, z: 29.0439453125 },
            { x: -3030.553955078125, y: 1852.3385009765625, z: 30.7288818359375 },
            { x: -2954.611083984375, y: 2103.138427734375, z: 40.822021484375 },
            { x: -2734.589111328125, y: 2254.971435546875, z: 20.5516357421875 },
            { x: -2662.668212890625, y: 2560.628662109375, z: 16.204345703125 },
            { x: -2616.35595703125, y: 2893.76708984375, z: 16.1875 },
            { x: -2578.786865234375, y: 3233.419677734375, z: 13.10400390625 },
            { x: -2485.094482421875, y: 3582.2373046875, z: 14.182373046875 },
            { x: -2387.88134765625, y: 3922.1142578125, z: 24.224853515625 },
            { x: -2251.58251953125, y: 4240.5625, z: 43.85498046875 },
            { x: -2155.55615234375, y: 4434.6328125, z: 62.4066162109375 },
            { x: -2004.06591796875, y: 4509.982421875, z: 56.5933837890625 },
            { x: -1808.17578125, y: 4704.5009765625, z: 56.5596923828125 },
            { x: -1568.953857421875, y: 4920.4482421875, z: 61.02490234375 },
            { x: -1341.2703857421875, y: 5121.3232421875, z: 61.176513671875 },
            { x: -1248.7252197265625, y: 5257.92529296875, z: 49.6007080078125 },
            { x: -1085.024169921875, y: 5317.10791015625, z: 47.17431640625 },
            { x: -868.12744140625, y: 5430.22412109375, z: 34.5706787109375 },
            { x: -617.116455078125, y: 5594.755859375, z: 38.5977783203125 },
            { x: -464.3999938964844, y: 5881.75390625, z: 32.7509765625 },
            { x: -250.78680419921875, y: 6117.60009765625, z: 30.7457275390625 },
            { x: -151.60879516601562, y: 6212.9404296875, z: 30.7457275390625, stop: true }, // STOP
            { x: -109.38461303710938, y: 6259.015625, z: 30.7288818359375 },
            { x: 52.589012145996094, y: 6422.53173828125, z: 30.830078125 },
            { x: 298.1011047363281, y: 6565.859375, z: 29.24609375 },
            { x: 619.1868286132812, y: 6526.31201171875, z: 27.7464599609375 },
            { x: 953.9208984375, y: 6482.861328125, z: 20.5684814453125 },
            { x: 1288.02197265625, y: 6482.90087890625, z: 19.79345703125 },
            { x: 1602.4088134765625, y: 6391.9384765625, z: 26.3311767578125 },
            { x: 1881.4681396484375, y: 6313.37158203125, z: 41.07470703125 },
            { x: 2028.791259765625, y: 6100.298828125, z: 47.4608154296875 },
            { x: 2264.21533203125, y: 5898.25048828125, z: 48.5391845703125 },
            { x: 2447.82861328125, y: 5619.71875, z: 44.4952392578125 },
            { x: 2552.42626953125, y: 5305.806640625, z: 44.141357421875 },
            { x: 2638.36474609375, y: 4984.62841796875, z: 44.2930908203125 },
            { x: 2715.60009765625, y: 4657.5166015625, z: 43.98974609375 },
            { x: 2795.037353515625, y: 4336.62841796875, z: 49.4996337890625 },
            { x: 2900.17578125, y: 4023.70556640625, z: 50.7296142578125 },
            { x: 2881.87255859375, y: 3697.041748046875, z: 52.195556640625 },
            { x: 2768.0439453125, y: 3384.857177734375, z: 55.5823974609375 },
            { x: 2598.38232421875, y: 3101.8154296875, z: 46.87109375 },
            { x: 2345.287841796875, y: 2878.45703125, z: 40.01318359375 },
            { x: 2078.940673828125, y: 2667.666015625, z: 51.0498046875 },
            { x: 1847.3802490234375, y: 2401.701171875, z: 54.217529296875 },
            { x: 1769.2879638671875, y: 2060.05712890625, z: 66.6190185546875 },
            { x: 1733.5252685546875, y: 1743.204345703125, z: 78.5992431640625 },
            { x: 1698.7384033203125, y: 1507.226318359375, z: 84.4967041015625 },
            { x: 1642.3912353515625, y: 1224.5802001953125, z: 84.7156982421875 },
            { x: 1533.5208740234375, y: 912.989013671875, z: 77.1669921875 },
            { x: 1344.6329345703125, y: 645.2044067382812, z: 80.04833984375 },
            { x: 1107.138427734375, y: 414.5802307128906, z: 83.249755859375 },
            { x: 870.2109985351562, y: 156.43516540527344, z: 73.123046875 },
            { x: 681.4285888671875, y: -139.43736267089844, z: 49.971435546875 },
            { x: 509.76263427734375, y: -359.4197692871094, z: 42.9619140625 },
            { x: 308.3736267089844, y: -482.1098937988281, z: 33.3743896484375 },
            { x: -5.406593322753906, y: -488.6109924316406, z: 33.1552734375 },
            { x: -349.5164794921875, y: -491.6307678222656, z: 24.781005859375 },
            { x: -692.7033081054688, y: -496.1802062988281, z: 24.6966552734375 },
            { x: -1045.6219482421875, y: -582.909912109375, z: 17.93994140625 },
            { x: -1378.20654296875, y: -735.006591796875, z: 10.4923095703125 },
            { x: -1717.5955810546875, y: -658.892333984375, z: 10.18896484375 },
            { x: -1971.982421875, y: -456.6065979003906, z: 11.3853759765625 },
            { x: -2015.129638671875, y: -452.9010925292969, z: 11.0146484375 },
            { x: -2006.4923095703125, y: -460.3912048339844, z: 11.04833984375 },
        ],

        [
            { x: -1997.195556640625, y: -467.81536865234375, z: 11.098876953125 },
            { x: -1927.002197265625, y: -525.7582397460938, z: 11.3685302734375 },
            { x: -1747.7802734375, y: -685.4241943359375, z: 9.6834716796875 },
            { x: -1563.89013671875, y: -840.3032836914062, z: 9.7171630859375 },
            { x: -1414.04833984375, y: -922.7340698242188, z: 10.6607666015625 },
            { x: -1323.3758544921875, y: -1067.4857177734375, z: 6.4989013671875 },
            { x: -1289.80224609375, y: -1214.4791259765625, z: 4.240966796875 },
            { x: -1193.4197998046875, y: -1433.3143310546875, z: 3.98828125 },
            { x: -1166.5450439453125, y: -1473.112060546875, z: 3.870361328125, stop: true }, // STOP
            { x: -1157.8681640625, y: -1484.980224609375, z: 3.88720703125 },
            { x: -1060.1669921875, y: -1624.087890625, z: 3.870361328125 },
            { x: -1005.8109741210938, y: -1594.7340087890625, z: 4.7127685546875 },
            { x: -1085.3670654296875, y: -1462.7076416015625, z: 4.5443115234375 },
            { x: -1057.120849609375, y: -1316.05712890625, z: 5.167724609375 },
            { x: -925.2395629882812, y: -1218.0791015625, z: 4.6285400390625 },
            { x: -784.2329711914062, y: -1132.826416015625, z: 10.18896484375 },
            { x: -696.975830078125, y: -1228.23291015625, z: 10.205810546875 },
            { x: -614.953857421875, y: -1282.813232421875, z: 10.239501953125 },
            { x: -527.1692504882812, y: -1175.4066162109375, z: 18.984619140625 },
            { x: -515.2351684570312, y: -1300.18017578125, z: 27.3421630859375 },
            { x: -475.23956298828125, y: -1425.7318115234375, z: 28.7237548828125 },
            { x: -287.73626708984375, y: -1440.4879150390625, z: 30.86376953125 },
            { x: -128.92747497558594, y: -1536.6329345703125, z: 33.7449951171875 },
            { x: -2.426372528076172, y: -1589.6571044921875, z: 28.87548828125 },
            { x: 131.12966918945312, y: -1434.975830078125, z: 28.858642578125 },
            { x: 226.971435546875, y: -1215.4417724609375, z: 28.858642578125 },
            { x: 234.90989685058594, y: -1060.4044189453125, z: 28.7069091796875 },
            { x: 355.4373779296875, y: -1064.6505126953125, z: 28.959716796875, stop: true }, // STOP
            { x: 365.037353515625, y: -1062.4615478515625, z: 28.858642578125 },
            { x: 395.68353271484375, y: -1116.5010986328125, z: 28.959716796875 },
            { x: 280.4175720214844, y: -1127.947265625, z: 28.858642578125 },
            { x: 257.23516845703125, y: -1124.6109619140625, z: 28.757568359375, stop: true }, // STOP
            { x: 245.03736877441406, y: -1128.3428955078125, z: 28.841796875 },
            { x: 54.81758117675781, y: -1127.93408203125, z: 28.87548828125 },
            { x: -213.58680725097656, y: -1134.6065673828125, z: 22.5904541015625 },
            { x: -455.96044921875, y: -1099.4373779296875, z: 28.15087890625 },
            { x: -534.5406494140625, y: -980.7296752929688, z: 22.860107421875 },
            { x: -496.25933837890625, y: -827.1428833007812, z: 30.021240234375 },
            { x: -555.7846069335938, y: -655.2922973632812, z: 32.818359375 },
            { x: -734.8087768554688, y: -648.6329345703125, z: 29.6168212890625 },
            { x: -974.7296752929688, y: -672.4219970703125, z: 23.3824462890625 },
            { x: -1099.75390625, y: -730.4835205078125, z: 19.4732666015625 },
            { x: -1210.826416015625, y: -598.8659057617188, z: 26.7861328125 },
            { x: -1300.2725830078125, y: -510.3692321777344, z: 32.6834716796875 },
            { x: -1458.3560791015625, y: -606.1450805664062, z: 30.4425048828125 },
            { x: -1610.10986328125, y: -604.997802734375, z: 31.6219482421875 },
            { x: -1719.91650390625, y: -553.1604614257812, z: 36.946533203125 },
            { x: -1851.7978515625, y: -487.6615295410156, z: 26.112060546875 },
            { x: -2020.4307861328125, y: -380.6373596191406, z: 10.5765380859375 },
            { x: -2018.0703125, y: -450.0263671875, z: 10.997802734375 },
            { x: -2002.5098876953125, y: -464.25494384765625, z: 11.065185546875 },
        ],

        [
            { x: -1993.3714599609375, y: -471.9296569824219, z: 11.132568359375 },
            { x: -1930.3121337890625, y: -510.6593322753906, z: 11.3685302734375 },
            { x: -1865.7362060546875, y: -548.2417602539062, z: 11.216796875 },
            { x: -1979.076904296875, y: -450.6329650878906, z: 11.3516845703125 },
            { x: -2120.10986328125, y: -351.982421875, z: 12.5816650390625 },
            { x: -2115.96923828125, y: -237.07252502441406, z: 17.181640625 },
            { x: -1943.090087890625, y: -189.63955688476562, z: 33.239501953125 },
            { x: -1822.3253173828125, y: -308.20220947265625, z: 41.849853515625 },
            { x: -1723.859375, y: -368.18902587890625, z: 46.7193603515625 },
            { x: -1618.3780517578125, y: -319.015380859375, z: 50.5780029296875 },
            { x: -1546.6021728515625, y: -366.8439636230469, z: 44.6300048828125 },
            { x: -1449.82421875, y: -437.19561767578125, z: 35.059326171875 },
            { x: -1288.4439697265625, y: -345.1516418457031, z: 36.2557373046875 },
            { x: -1098.751708984375, y: -238.28570556640625, z: 37.3004150390625 },
            { x: -874.6285400390625, y: -119.5252685546875, z: 37.4857177734375 },
            { x: -675.94287109375, y: -20.492305755615234, z: 37.906982421875 },
            { x: -509.6307678222656, y: -4.0615386962890625, z: 44.2762451171875 },
            { x: -340.6549377441406, y: -28.378021240234375, z: 47.17431640625 },
            { x: -270.3428649902344, y: -88.61538696289062, z: 47.6966552734375 },
            { x: -289.75384521484375, y: -239.35385131835938, z: 34.5538330078125 },
            { x: -271.3582458496094, y: -368.0967102050781, z: 29.6168212890625 },
            { x: -208.85275268554688, y: -503.6835021972656, z: 34.2843017578125 },
            { x: -256.0087890625, y: -656.953857421875, z: 32.7171630859375 },
            { x: -244.54945373535156, y: -714.3296508789062, z: 32.98681640625, stop: true }, // STOP
            { x: -275.72308349609375, y: -815.4329833984375, z: 31.3187255859375 },
            { x: -249.56044006347656, y: -880.5758056640625, z: 30.2572021484375, stop: true }, // STOP
            { x: -231.16482543945312, y: -887.076904296875, z: 29.5831298828125 },
            { x: -231.21759033203125, y: -983.7758178710938, z: 28.824951171875 },
            { x: -285.69232177734375, y: -1173.9560546875, z: 22.6072998046875 },
            { x: -286.3648376464844, y: -1384.6549072265625, z: 30.830078125 },
            { x: -297.3758239746094, y: -1527.3099365234375, z: 27.22412109375 },
            { x: -399.3626403808594, y: -1720.7471923828125, z: 18.6981201171875 },
            { x: -357.3494567871094, y: -1833.81103515625, z: 22.3377685546875 },
            { x: -183.58680725097656, y: -1797.6790771484375, z: 29.3978271484375 },
            { x: -65.14285278320312, y: -1801.4241943359375, z: 27.0556640625 },
            { x: 57.270328521728516, y: -1894.03515625, z: 21.0234375 },
            { x: 151.93846130371094, y: -1798.3385009765625, z: 28.2857666015625 },
            { x: 245.05055236816406, y: -1850.228515625, z: 26.09521484375 },
            { x: 440.967041015625, y: -2030.3341064453125, z: 23.0791015625, stop: true }, // STOP
            { x: 455.6044006347656, y: -2042.5845947265625, z: 23.753173828125 },
            { x: 412.0747375488281, y: -2131.252685546875, z: 18.00732421875 },
            { x: 281.4989013671875, y: -2108.39990234375, z: 15.5977783203125 },
            { x: 142.08792114257812, y: -2034.11865234375, z: 17.87255859375 },
            { x: 4.404395580291748, y: -2031.78466796875, z: 17.822021484375 },
            { x: -134.26812744140625, y: -2076.830810546875, z: 25.3033447265625 },
            { x: -152.6637420654297, y: -2005.9912109375, z: 22.3883056640625 },
            { x: -194.26812744140625, y: -1884.6856689453125, z: 26.98828125 },
            { x: -294.3824157714844, y: -1827.4285888671875, z: 25.7076416015625 },
            { x: -397.31866455078125, y: -1777.068115234375, z: 20.6864013671875 },
            { x: -550.3516235351562, y: -1748.927490234375, z: 21.4447021484375 },
            { x: -689.8153686523438, y: -1624.6812744140625, z: 23.095947265625 },
            { x: -644.967041015625, y: -1471.6087646484375, z: 10.12158203125 },
            { x: -632.4263916015625, y: -1297.3978271484375, z: 10.205810546875 },
            { x: -729.4154052734375, y: -1168.826416015625, z: 10.18896484375 },
            { x: -860.1758422851562, y: -939.9560546875, z: 15.5135498046875 },
            { x: -1038.2109375, y: -794.3472290039062, z: 17.6365966796875 },
            { x: -1152.6329345703125, y: -817.3582153320312, z: 14.249755859375 },
            { x: -1288.3912353515625, y: -884.5450439453125, z: 10.896728515625 },
            { x: -1363.4110107421875, y: -811.1868286132812, z: 18.849853515625 },
            { x: -1498.5098876953125, y: -796.3120727539062, z: 17.4007568359375 },
            { x: -1734.4088134765625, y: -628.5494384765625, z: 10.5765380859375 },
            { x: -1967.4461669921875, y: -460.74725341796875, z: 11.3853759765625 },
            { x: -2007.78466796875, y: -459.3626403808594, z: 11.031494140625 },
            { x: -2002.4835205078125, y: -463.20001220703125, z: 11.065185546875 },
        ],
    ],

    BusWay(type) {
        let points = this.ways;
        let point = this.idx;
        let nextPoint = points[type][point + 1];
        if (points[type][this.idx].stop == true) {
            this.blipType = 81;
            this.colshapeType = 'stop';
            this.rgba = { r: 247, g: 255, b: 0, a: 100 };
        } else {
            this.blipType = 84;
            this.rgba = { r: 7, g: 48, b: 250, a: 100 };
        }
        this.busCheckpoint = new alt.Checkpoint(
            'CylinderCycleArrow',
            new alt.Vector3(points[type][point].x, points[type][point].y, points[type][point].z - 2),
            new alt.Vector3(nextPoint.x, nextPoint.y, nextPoint.z),
            5,
            5,
            this.rgba
        );
        this.busBlip = new alt.PointBlip(points[type][point].x, points[type][point].y, points[type][point].z);
        this.busBlip.color = this.blipType;
        this.busColshape = new clientColshape(
            player,
            {
                x: points[type][point].x,
                y: points[type][point].y,
                z: points[type][point].z,
            },
            5,
            true,
            enterColshape,
            exitColshape
        );
    },
};

browser.on('Bus_startWork::CLIENT', (route, _salary) => {
    salary = _salary;
    busWayType = route;
    buswork = true;
    alt.emit('Bus_hideBusWindow::CLIENT');
    alt.emitServer('Bus_startWork::SERVER');
    opened = false;
});

browser.on('Bus_endWork::CLIENT', () => {
    endWork();
});

alt.onServer('Bus_endServerWork::CLIENT', () => {
    endWork();
});

function endWork() {
    alt.emitServer('Bus_endWork::SERVER');
    if (BusWork.busColshape != null && BusWork.busCheckpoint != null && BusWork.busBlip != null) {
        BusWork.busColshape.destroyColshape();
        BusWork.busBlip.destroy();
        BusWork.busCheckpoint.destroy();
        BusWork.colshapeType = null;
    }
}

alt.onServer('Bus_startRoute::CLIENT', () => {
    BusWork.BusWay(busWayType);
});

let inColshape = false;
let timeout;

function enterColshape() {
    if (player.vehicle) {
        if (player.vehicle.hasSyncedMeta('BUS_VEH')) {
            inColshape = true;
        }

        if (BusWork.colshapeType == 'stop') {
            addNotify(1, 'Остановитесь на 10 секунд.', 5000);
            timeout = alt.setTimeout(() => {
                if (inColshape == true) {
                    addNotify(1, 'Продолжайте движение.', 5000);
                    BusWork.idx++;
                    BusWork.busColshape.destroyColshape();
                    BusWork.busBlip.destroy();
                    BusWork.busCheckpoint.destroy();
                    BusWork.colshapeType = null;
                    BusWork.BusWay(busWayType);
                } else {
                    addNotify(1, 'Остановитесь на 10 секунд.', 5000);
                }
            }, 10000);
        }

        if (BusWork.idx == BusWork.ways[busWayType].length - 1) {
            BusWork.idx = 0;
            BusWork.busColshape.destroyColshape();
            BusWork.busBlip.destroy();
            BusWork.busCheckpoint.destroy();
            BusWork.BusWay(busWayType);
            earnedMoney += salary;
            alt.emitServer('Bus_endWay::SERVER', earnedMoney);
            return;
        }

        BusWork.idx++;
        BusWork.busColshape.destroyColshape();
        BusWork.busBlip.destroy();
        BusWork.busCheckpoint.destroy();
        BusWork.BusWay(busWayType);
    }
}

function exitColshape() {
    inColshape = false;
}
